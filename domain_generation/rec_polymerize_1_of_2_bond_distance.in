# Polymerization script for TMC carbon to MPD nitrogen 
# Usage: Ensure call to LAMMPS is made from folder where data.lmps is saved, 
# assume that reaction scripts are contained in ../../scripts from folder where data.lmps is saved.
# Usage: Ensure command line defines -var mult, -var rand, -var xlink, and -var scale

# System
log logs/log.POLYM
units            real
atom_style       full
dimension        3
newton           off
boundary         p p p 
echo             none 

# Styles
pair_style       lj/charmm/coul/long 7.0 9.0
pair_modify      shift no mix sixthpower
kspace_style     pppm 1.0e-4
kspace_modify    diff ad
bond_style       harmonic
angle_style      harmonic
dihedral_style   charmm
improper_style   harmonic
special_bonds    charmm


# Set up domain size
variable BOXSIZE_X equal 90*${mult}^(1/3)
variable BOXSIZE_Y equal 90*${mult}^(1/3)

# Scale z dimension
variable BOXSIZE_Z equal 90*${mult}^(1/3)*${scale} 

# Scale factor for atoms
variable mult_scaling equal ${mult}*${scale} 

# Set up number of atoms and molecules
variable MPD_mol_count equal 300*${mult_scaling}
variable TMC_mol_count equal 200*${mult_scaling}

# Num MPD + TMC atoms
variable all_atom_count equal ${mult_scaling}*200*18+${mult_scaling}*300*16 
variable MPD_atom_count equal ${mult_scaling}*300*16 
variable TMC_atom_count equal ${mult_scaling}*200*18

#dump 1 all custom 1000 logs/trajectory_polym.lammpstrj id type x y z vx vy vz #aj added line for VMD visualization
read_data ../../domain_in/TMC_converted.lmps extra/improper/per/atom 2
displace_atoms all move $(5*v_mult) $(5*v_mult) $(5*v_mult_scaling) units box
delete_atoms group all
change_box all x final 0 ${BOXSIZE_X} y final 0 ${BOXSIZE_Y} z final 0 ${BOXSIZE_Z}  #change boxsizes
lattice fcc 11.3

# Read in MPD/TMC molecule info and RXN 
molecule MPDmol ../../domain_in/MPD.mol 
molecule TMCmol ../../domain_in/TMC.mol
molecule mol1 ../../domain_in/MPD_TMC_prerxn.mol
molecule mol2 ../../domain_in/MPD_TMC_postrxn.mol

# Increase the box size 
region WHOLEBOX block $(xlo+10) $(xhi-5) $(ylo+10) $(yhi-5) $(zlo+10) $(zhi-5) units box side in

# Add the MPD molecules 
create_atoms 0 box subset ${MPD_mol_count} $(25523*v_rand) mol MPDmol 212123
group MPDs union all
dump 1 all custom 1000 logs/initial_structure.lammpstrj id type x y z vx vy vz
undump 1


# Add in the TMC molecules 
label tmc_pack_loop
variable p loop 1000
variable TMC_mol_count_to_add equal (${all_atom_count}-$(atoms))/18
create_atoms 0 box subset ${TMC_mol_count_to_add} $(525621*v_p*v_rand) mol TMCmol 325132
group TMCs subtract all MPDs
print "TMC molecules needed to be added ${TMC_mol_count_to_add}"
print "Number of atoms in TMCs group: $(count(TMCs))"
delete_atoms overlap 1.0 TMCs all mol yes
fix 1 all nve
run 0
unfix 1
if "$(atoms) == ${all_atom_count}" then "jump SELF tmc_pack_break"
next p
jump SELF tmc_pack_loop

# Initial packing completed
label tmc_pack_break
dump 2 all custom 1000 logs/packing_structure.lammpstrj id type x y z vx vy vz
undump 2
reset_atoms id

# Minimize after add TMC Molecules 
dielectric       1.0
neighbor         2.0 bin
neigh_modify     delay 0 every 1 check yes
timestep         10.0
run_style        verlet

# Minimization Step
min_style        sd
minimize         1.0e-5 1.0e-5 10000 100000
min_style        cg
min_modify       line quadratic
minimize         1.0e-8 1.0e-8 10000 100000
timestep 1.0

write_data tmc_mpd_packed_domain.lmps

# xlinking target by counting amide groups
group NUM_AMIDE type 7
variable MAX_BONDS equal count(NUM_AMIDE)
print "MAX_BONDS = ${MAX_BONDS}"
variable TARGET_BONDS equal (${MAX_BONDS}*${xlink}) #target crosslinking degree


# Set up for tracking bond count
# outer_bound_count holds the count when we change approaches and need to delete (unfix) the reaction. 
# inner_bound_count tracks the bond count for a specific method/ instance of a reaction
variable outer_bond_count equal 0
variable current_bond_count equal 0
fix bond_tracking all print 1 "Bonds Approach Count Iteration Count " file iterations_bond_distance.out title "" screen no

# Set the maximum number of approaches we are going to use
variable num_approaches equal 5 
variable approach_attempt loop $(v_num_approaches)

# Label for outer loop. Here we can modify the approach 
# (i..e. increased the reaction radius or delete and re-insert TMC and MPD)
label update_approach 

# Set bond parameters
variable max_bond_distance equal 5.0
variable bond_frequency equal 50

if "${approach_attempt} > 1" then &
  "variable max_bond_distance equal $(v_max_bond_distance + 1*v_approach_attempt)"

# Define reaction 
fix PArxn all bond/react stabilization yes statted_grp .03 &
  react rxn1 all ${bond_frequency} 0.0 ${max_bond_distance} mol1 mol2 ../../domain_in/MPDTMC_rxnmap.in

# Set to track bond count with this approach 
variable inner_bond_count equal f_PArxn[1]
thermo 0
thermo_style custom step temp press density v_current_bond_count

# Set up inner loop 
label keep_reacting
variable loop_count equal 10
variable inner_loop loop $(v_loop_count)


# if "${inner_loop} > 3" then "restart 10000 restarts_polym/polym.restart" 
print "==================================Current bonds formed = ${current_bond_count} Minimum bonds desired = ${TARGET_BONDS}======================================="
print "==================================NVT PA POLYMERIZATION RUN: 300 C==============================="
velocity all create 300.0 $(66644*v_inner_loop*v_rand)


# Track the bond count and other information in file 
fix bond_tracking all print 2000 "Bonds ${current_bond_count} Approach Count ${approach_attempt} Iteration Count ${inner_loop} Bond Distance ${max_bond_distance}" append iterations_bond_distance.out title "" screen no


# Reacting and unreacting 
fix 1 statted_grp_REACT nvt temp 300 300 $(100.*dt)
fix 4 bond_react_MASTER_group temp/rescale 50 300 300 10 1

# Run 1000 timesteps
run  1000
unfix 1
unfix 4

fix 1 statted_grp_REACT npt temp 300 300 $(100.*dt) iso 0.5 0.5 $(100.*dt)
fix 4 bond_react_MASTER_group temp/rescale 50 300 300 10 1

run 1000
unfix 1
unfix 4

reset_atoms id

#Get the correct bonds
 if "${outer_bond_count} == 0" then  &
    "variable current_bond_count equal $(v_inner_bond_count)" &
 else &
    "variable current_bond_count equal $(v_inner_bond_count + v_outer_bond_count)"

### Check if done! 
if "${current_bond_count} >= ${TARGET_BONDS}" then "jump SELF end_bond_forming"

# Keep on going if not done. boo!
print "Approach: ${approach_attempt} Inner Loop: ${inner_loop}"
print "Bond count ${current_bond_count}"

# Determine if we should update our approach 
if "${inner_loop} == ${loop_count}" then &
  "variable outer_bond_count equal $(v_current_bond_count)" &
  "next approach_attempt" &
  "variable inner_loop delete" &
  "jump SELF update_approach" &
elif "${num_approaches} == ${approach_attempt}" &
  "jump SELF end_bond_forming" &
else &
  "next inner_loop" &
 "jump SELF keep_reacting"

label end_bond_forming
print "==================================FORMING BONDS COMPLETE DONE: Total bonds formed = ${current_bond_count}============"
print "${current_bond_count}" file PA_bonds.in
variable  PAbonds_final equal ${current_bond_count}
unfix PArxn


velocity all scale 300.0
fix 1 all nvt temp 300 300 $(100.*dt)
dump 3 all custom ${bond_frequency} logs/polymerization_structure.lammpstrj id type x y z vx vy vz 
# variable final_steps equal 100000-$(step) #aj changed from 750000
print "==================================PA EQUILIBRATION ================="
thermo_style custom step temp press density
run 10000
unfix 1
undump 3


# Data file output
reset_atoms id
write_data       logs/polym.lmps

#Remove Hexane
group HEXANE type 9 10
delete_atoms group HEXANE
reset_atoms id
write_data       logs/polym_clean.lmps
